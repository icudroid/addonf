<!DOCTYPE html>
<html
        xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
        layout:decorator="layout/logged"
        ng-app="myModule">

<head>
    <title th:text="${title}">Title</title>

    <link rel="stylesheet" th:href="@{/css/chosen-mtzik.css}"/>
    <script th:src="@{/lib/chosen-1.0/chosen.jquery.js}"></script>

    <script th:src="@{/lib/angular-1.2.0/angular.js}"></script>
    <script th:src="@{/lib/angular-1.2.0/angular-animate.js}"></script>
    <script th:src="@{/lib/angular-1.2.0/angular-resource.js}"></script>
    <script th:src="@{/lib/angular-1.2.0/angular-route.js}"></script>

    <script th:src="@{/js/service/services.js}"></script>
    <script th:src="@{/js/service/campaign-services.js}"></script>
    <script th:src="@{/js/directive/directives.js}"></script>

    <script th:src="@{/lib/ui-bootstrap-0.10.0/ui-bootstrap-tpls-0.10.0.js}"></script>

    <script th:src="@{/lib/plupload-angular-directive/src/lib/plupload/plupload.full.js}"></script>
    <script th:src="@{/lib/plupload-angular-directive/src/js/plupload-angular-directive.js}"></script>


    <script type="text/javascript">

        var controllers = angular.module('myModule', ['ui.bootstrap','services','campaignServices', 'directives', 'plupload.module', 'ngResource']);

        controllers.controller('Step3Ctrl', ['$scope', 'Services', 'Campaign', '$modal', '$resource',
            function($scope, Services, Campaign, $modal,$resource) {
                $scope.format = "dd/MM/yyyy";
                var CreateCampaign =  $resource(addonf.base+"createCampaign/rule",{_csrf:addonf.token},
                        {
                            addBrandRule: {method:'POST', params:{addBrandRule:true}, isArray:false},
                            removeBrandRule: {method:'POST', params:{removeBrandRule:true}, isArray:false},
                            modifyBrandRule: {method:'POST', params:{removeBrandRule:true}, isArray:false}
                        });


                $scope.model = Campaign.getCurrent();

                $scope.addBrandRule = function(){

                    var brandRuleModal = $modal.open({
                        templateUrl: addonf.base+'manageAds/partials/create/modalBrand.html',
                        controller: "AddBrandRuleCtrl",
                        resolve: {
                            rule: function () {
                                return {
                                    isNew :true,
                                    startDate : $scope.model.information.startDate,
                                    endDate : $scope.model.information.endDate
                               };
                            }
                        }
                    });

                    brandRuleModal.result.then(function (brandRule) {
                        CreateCampaign.addBrandRule({},brandRule,function(data){
                            if(data.errors){
                                alert(data.errors);
                            }else{
                                $scope.model.adServices.brandRules.push(brandRule);
                            }

                        });
                    }, function () {});

                };


                $scope.modifyBrandRule = function(rule){
                    var brandRuleModal = $modal.open({
                        templateUrl: addonf.base+'manageAds/partials/create/modalBrand.html',
                        controller: "AddBrandRuleCtrl",
                        resolve: {
                            rule: function () {
                                return rule;
                            }
                        }
                    });

                    brandRuleModal.result.then(function (brandRule) {
                        $scope.removeBrandRule(rule);
                        CreateCampaign.addBrandRule({},brandRule,function(data){
                            if(data.errors){
                                alert(data.errors);
                            }else{
                                $scope.model.adServices.brandRules.push(brandRule);
                            }

                        });

                    }, function () {});
                };


                $scope.removeBrandRule = function(rule){

                    var index = $scope.model.adServices.brandRules.indexOf(rule);
                    if (index > -1) {

                        CreateCampaign.removeBrandRule({},$scope.model.adServices.brandRules[index], function(data) {
                            if(data.errors){
                                alert(data.errors);
                            }else{
                                $scope.model.adServices.brandRules.splice(index,1);
                            }
                        });


                    }
                }

                $scope.addOpenRule= function(){

                    var opneRuleModal = $modal.open({
                        templateUrl: addonf.base+'manageAds/partials/create/modalOpen.html',
                        controller: "AddOpenRuleCtrl",
                        resolve: {
                            rule: function () {
                                return {
                                    isNew :true,
                                    startDate : $scope.model.information.startDate,
                                    endDate : $scope.model.information.endDate
                                };
                            }
                        }
                    });

                    opneRuleModal.result.then(function (openRule) {
                        /*CreateCampaign.addBrandRule({},brandRule,function(data){
                            if(data.errors){
                                alert(data.errors);
                            }else{
                                $scope.model.adServices.brandRules.push(brandRule);
                            }

                        });*/
                    }, function () {});

                };


            }
        ]);



        controllers.controller('AddBrandRuleCtrl', ['$scope', 'Services', '$modalInstance', 'rule',
            function($scope, Services, $modalInstance ,rule) {
                $scope.base=addonf.base;
                $scope.brands = [];
                if(rule.isNew){
                    $scope.brandRule = {
                        noDisplayWith : [],
                        startDate : rule.startDate,
                        endDate : rule.endDate
                    };
                    $scope.btnValidate = "valider"
                }else{
                    $scope.brandRule = rule;
                    $scope.btnValidate = "Modifier"
                }
                $scope.selectedBrand = {};
                $scope.format = "dd/MM/yyyy";
                $scope.nbDisplay = [1,2,3,4,5,6,7,8,9,10];

                Services.getBrands(function(data){
                    $scope.brands = data;
                });

                $scope.addNoShowWith = function(selectedBrand){
                    if(!angular.isUndefined(selectedBrand.id)){
                        var index = $scope.brandRule.noDisplayWith.indexOf(selectedBrand);
                        if(index == -1){
                            $scope.brandRule.noDisplayWith.push(selectedBrand);
                        }else{
                            alert("Companie déjà sélectionnée");
                        }

                    }else{
                        alert("aucune companie sélectionnée");
                    }
                };

                $scope.removeBrandRule = function(brand){
                    var index = $scope.brandRule.noDisplayWith.indexOf(brand);
                    if (index > -1) {
                        $scope.brandRule.noDisplayWith.splice(index, 1);
                    }
                };


                $scope.ok = function () {
                    $modalInstance.close($scope.brandRule);
                };

                $scope.cancel = function () {
                    $modalInstance.dismiss('cancel');
                };
            }
        ]);



        controllers.controller('AddOpenRuleCtrl', ['$scope', 'Services', '$modalInstance', 'rule',
            function($scope, Services, $modalInstance ,rule) {
                $scope.base=addonf.base;
                $scope.img = [];
                $scope.percent = [];

                $scope.getUploadUrl = function (index){
                    return addonf.base+"createCampaign/upload/"+"0"+"/"+index+"?_csrf="+addonf.token;
                }

                $scope.getDownloadTmpImageUrl = function (index){
                    return addonf.base+"createCampaign/tmpImage/"+index+"?"+new Date().getTime();
                }

                $scope.setNowTmpImageUrl = function (index){
                    $scope.img[index] = $scope.getDownloadTmpImageUrl(index);
                }


                $scope.setNowTmpImageUrl(0);
                $scope.setNowTmpImageUrl(1);
                $scope.setNowTmpImageUrl(2);

                $scope.percent[0] = 0;
                $scope.percent[1] = 0;
                $scope.percent[2] = 0;




                if(rule.isNew){
                    $scope.openRule = {
                        responses : [
                            {
                                correct:false
                            },
                            {
                                correct:false
                            },
                            {
                                correct:false
                            }
                        ],
                        startDate : rule.startDate,
                        endDate : rule.endDate
                    };
                    $scope.btnValidate = "valider"
                }else{
                    $scope.openRule = rule;
                    $scope.btnValidate = "Modifier";
                }

                $scope.format = "dd/MM/yyyy";
                $scope.nbDisplay = [1,2,3,4,5,6,7,8,9,10];


                $scope.ok = function () {
                    $modalInstance.close($scope.openRule);
                };

                $scope.cancel = function () {
                    $modalInstance.dismiss('cancel');
                };
            }
        ]);

    </script>
</head>


<body>

<div layout:fragment="menu">
    <div th:replace="layout/fragment/menu(activeFirstMenu=${'ads'},activeSecondMenu=${'create'})"></div>
</div>

<h4 class="innerAll bg-white margin-none" layout:fragment="formTile" th:text="#{addonf.create.ad}"></h4>


<div layout:fragment="content" class="col-table">

    <div class="widget" ng-controller="Step3Ctrl">

        <div class="wizard" id="rootwizard">

            <!-- Wizard heading -->
            <div class="wizard-head">
                <ul class="bwizard-steps">
                    <li><a>Informations Générales</a></li>
                    <li><a>Choix du public</a></li>
                    <li class="active"><a>Choix d'affichages</a></li>
                </ul>
            </div>
            <!-- // Wizard heading END -->

            <div class="widget">

                <div class="widget-body">
                    <div class="tab-content">

                        <!-- Step 1 -->
                        <div class="tab-pane active">


                            <div class="heading-buttons border-bottom innerLR">
                                <div class="btn-group pull-right">
                                    <a class="btn btn-primary" href="#" ng-click="addBrandRule()"><i class="fa fa-fw fa-plus-circle"></i> Affichage par Logo</a>
                                    <a class="btn btn-primary" href="#" ng-click="addOpenRule()"><i class="fa fa-fw fa-plus-circle"></i> Affichage Personnalisé</a>
                                </div>
                                <h4 class="margin-none innerTB">Choix d'affichages :</h4>
                                <div class="clearfix"></div>
                            </div>

                            <div class="separator bottom"></div>

                                <table class="table table-striped">
                                    <tr>
                                        <th width="20%">Type d'affichage</th>
                                        <th width="40%">Dates</th>
                                        <th width="30%">Nb max. vue / jour / utilisateur</th>
                                        <th width="20%">Actions</th>
                                    </tr>
                                    <tr ng-repeat="brandRule in model.adServices.brandRules">
                                        <td>Par Logo</td>
                                        <td>entre le {{brandRule.startDate | date:format}} et le {{brandRule.endDate | date:format}}</td>
                                        <td>{{brandRule.maxDisplayByUser}}</td>
                                        <td>
                                            <a class="btn  btn-success" href="#" ng-click="modifyBrandRule(brandRule)"><i class="fa fa fa-pencil"></i></a>
                                            <a class="btn  btn-danger" href="#" ng-click="removeBrandRule(brandRule)"><i class="fa fa-times"></i></a>
                                        </td>
                                    </tr>

                                    <tr ng-repeat="openRule in model.adServices.openRules">
                                        <td>Personnalisé</td>
                                        <td>entre le {{openRule.startDate | date:format}} et le {{openRule.endDate | date:format}}</td>
                                        <td>{{openRule.maxDisplayByUser}}</td>
                                        <td>
                                            <a class="btn  btn-success" href="#" ng-click="modifyOpenRule(openRule)"><i class="fa fa fa-pencil"></i></a>
                                            <a class="btn  btn-danger" href="#" ng-click="removeOpenRule(openRule)"><i class="fa fa-times"></i></a>
                                        </td>
                                    </tr>

                                </table>


                            <div class="text-right innerAll border-top">
                                <div class="btn-group btn-group-sm">
                                    <a class="btn btn-default" th:href="@{/createCampaign/step2}"><i class="fa fa-chevron-left"></i> Retour</a>
                                    <a class="btn btn-primary" th:href="@{/createCampaign/save}"><i class="fa fa-fw fa-check"></i> Valider</a>
                                </div>
                            </div>



                        <!-- // Step 1 END -->

                    </div>


                </div>
            </div>
        </div>

    </div>
</div>

</div>
</body>
</html>
