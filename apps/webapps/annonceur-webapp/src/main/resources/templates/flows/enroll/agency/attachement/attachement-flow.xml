<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

    <var name="state" class="fr.k2i.adbeback.webapp.state.enroll.AgencyEnrollFlowState"/>
    <var name="agencyEnrollCommand" class="fr.k2i.adbeback.webapp.bean.enroll.AgencyEnrollCommand"/>

    <on-start>
        <set name="flowScope.activeId" value="5"/>
    </on-start>

    <view-state id="attachments" view="enroll/common/attachement">
        <on-entry>
            <evaluate expression="agencyEnrollHelper.availableFiles(state)" result="viewScope.files"/>
            <evaluate expression="agencyEnrollHelper.requiredFiles(state)" result="viewScope.requiredFiles"/>
            <evaluate expression="agencyEnrollHelper.uploadedFileStatus(state,agencyEnrollCommand.attachements)" result="viewScope.filesStatus"/>
        </on-entry>
        <transition on="submit" to="isAllFilePresent" />
        <transition on="back" to="back" />
        <transition to="step">
            <set value="currentEvent.id" name="flashScope.whereToGo"/>
        </transition>
    </view-state>



    <action-state id="whereToGo">
        <evaluate expression="flowScope.toGo"/>
        <transition on="${flowScope.toGo}" to="${flowScope.toGo}">
        </transition>
    </action-state>

    <action-state id="isAllFilePresent">
        <evaluate expression="agencyEnrollHelper.saveFiles(agencyEnrollCommand, externalContext)"/>
        <transition on="ok" to="end-attachement" />
        <transition on="ko" to="attachments"/>
        <transition on="NeedMoreFile" to="needMoreFile" />
    </action-state>

    <view-state id="needMoreFile" view="enroll/common/popup/needMoreFile" popup="true">
        <transition  on="back"  to="attachments" />
    </view-state>

    <end-state id="end-attachement">
        <output name="state" value="state"/>
    </end-state>
    <end-state id="back">

    </end-state>



    <end-state id="step">
        <output name="whereToGo" value="flashScope.whereToGo"/>
    </end-state>

</flow>